@using CheckBoardGameVersion3.Data.Models
@using Microsoft.AspNetCore.SignalR.Client;
@inject NavigationManager NavigationManager

@if (inBoard)
{
    <CheckBoard hubsConnection="hubConnection" TableId="@tableId" Player="@NextPlayer"></CheckBoard>
}
else if (inGame)
{
    <SelectChecker HubsConnection="hubConnection" TableId="@tableId"></SelectChecker>
}
else
{
    <button @onclick="CreateGame">Create Game</button>
    @foreach (var table in tables)
    {
        <button @onclick="()=>JoinGame(table)">Join table @table</button>
    }
}

@code {
    bool inGame;
    bool inBoard;
    SetTeam NextPlayer;

    HubConnection hubConnection = new HubConnectionBuilder()
           .WithUrl("https://localhost:7065/connect")
           .Build();

    protected override async Task OnInitializedAsync()
    {
        await RefreshTables();
    }

    List<string> tables = new List<string>();
    List<SetTeam> colors = new();
    string tableId = default;

    async Task JoinGame(string tableId)
    {
        await hubConnection.StartAsync();
        this.tableId = tableId;
        await hubConnection.SendAsync("JoinTable", tableId);
        NextPlayer = colors[0] == SetTeam.Black ? SetTeam.White : SetTeam.Black;
        inBoard = true;
        inGame = false;
    }

    async Task RefreshTables()
    {
        HttpClient client = new HttpClient();
        tables = await client.GetFromJsonAsync<List<string>>
                 ("https://localhost:7065/Api/GetTables");
        colors = await client.GetFromJsonAsync<List<SetTeam>>
                 ("https://localhost:7065/Api/GetColor");
    }


    async Task CreateGame()
    {
        await hubConnection.StartAsync();
        tableId = Guid.NewGuid().ToString();
        await hubConnection.SendAsync("JoinTable", tableId);
        inGame = true;
    }
}