@using CheckBoardGameVersion3.Data.Models
@using Microsoft.AspNetCore.SignalR.Client;
@inject NavigationManager NavigationManager

@if (inBoard)
{
    <CheckBoard HubsConnection="hubConnection" TableId="@tableId" Player="@NextPlayer"></CheckBoard>
}
else if (inGame)
{
    <SelectChecker HubsConnection="hubConnection" TableId="@tableId"></SelectChecker>
}
else
{
    <div style="text-align: -webkit-center">
        <div class="createGame">
            <button class="btn btn-primary form-group-append"
                @onclick="CreateGame">
                Create Game
            </button>
        </div>
        @foreach (var table in tables)
        {
            <div class="joinGame">
                <button class="btn btn-primary form-group-append" @onclick="()=>JoinGame(table)">Join table @NextPlayer</button>
            </div>
        }
    </div>
}

@code {
    bool inGame;
    bool inBoard;
    SetTeam NextPlayer;

    HubConnection hubConnection = new HubConnectionBuilder()
           .WithUrl("https://localhost:7065/connect")
           .Build();

    protected override async Task OnInitializedAsync()
    {
        await RefreshTables();
        if (colors.Any())
        {
            NextPlayer = colors[0] == SetTeam.Black ? SetTeam.White : SetTeam.Black;
        }
        
    }

    List<string> tables = new List<string>();
    List<SetTeam> colors = new();
    string tableId = default;

    async Task JoinGame(string tableId)
    {
        await hubConnection.StartAsync();
        this.tableId = tableId;
        await hubConnection.SendAsync("JoinTable", tableId);
        
        inBoard = true;
        inGame = false;
    }

    async Task RefreshTables()
    {
        HttpClient client = new HttpClient();
        tables = await client.GetFromJsonAsync<List<string>>
                 ("https://localhost:7065/Api/GetTables");
        colors = await client.GetFromJsonAsync<List<SetTeam>>
                 ("https://localhost:7065/Api/GetColor");
    }


    async Task CreateGame()
    {
        await hubConnection.StartAsync();
        tableId = Guid.NewGuid().ToString();
        await hubConnection.SendAsync("JoinTable", tableId);
        inGame = true;
    }
}